<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ä¹ æ€æƒ³é€‰æ‹©åˆé›†ï¼ˆç™»å½•ç‰ˆï¼‰</title>
  <style>
    /* åŸºç¡€æ ·å¼ */
    body {
      font-family: "Microsoft YaHei", sans-serif;
      line-height: 1.6;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
      padding-right: 280px;
    }

    /* ç™»å½•ç•Œé¢æ ·å¼ */
    .login-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 10000;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
    }

    .login-box {
      background: white;
      padding: 30px;
      border-radius: 8px;
      color: #333;
      width: 350px;
      max-width: 90%;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }

    .login-title {
      text-align: center;
      margin-bottom: 20px;
      color: #1e88e5;
    }

    .login-input {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }

    .login-btn {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      background-color: #1e88e5;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }

    .login-btn:hover {
      background-color: #1565c0;
    }

    .login-error {
      color: #e53935;
      text-align: center;
      margin: 10px 0;
      font-size: 14px;
    }

    /* ç”¨æˆ·ä¿¡æ¯æ  */
    .user-info {
      position: fixed;
      top: 10px;
      right: 300px;
      background: white;
      padding: 5px 10px;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      font-size: 14px;
      z-index: 1001;
    }

    .logout-btn {
      color: #1e88e5;
      cursor: pointer;
      margin-left: 10px;
    }

    /* é¢˜ç›®æ ·å¼ */
    .question-block {
      background-color: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: relative;
    }

    .question-header {
      margin-bottom: 10px;
      font-weight: bold;
      padding-left: 30px;
    }

    .question-marker {
      position: absolute;
      left: 10px;
      top: 10px;
      cursor: pointer;
      font-size: 1.2em;
      user-select: none;
    }

    .question-marker.marked {
      color: gold;
      text-shadow: 0 0 2px black;
    }

    .options {
      margin-left: 20px;
    }

    .option {
      margin-bottom: 5px;
      padding: 5px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .option:hover {
      background-color: #f0f0f0;
    }

    .option.selected {
      background-color: #e0e0e0 !important;
    }

    .option.correct {
      background-color: #e8f5e9 !important;
      color: #2e7d32;
      font-weight: bold;
    }

    .option.wrong {
      background-color: #ffebee !important;
      color: #c62828;
      text-decoration: line-through;
    }

    .correct-answer {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed #ccc;
      font-style: italic;
      color: #2c3e50;
      display: none;
    }

    .answer-feedback {
      margin-top: 10px;
      font-weight: bold;
      display: none;
    }

    .check-btn, .reset-btn {
      padding: 5px 10px;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }

    .check-btn {
      background-color: #1e88e5;
    }

    .check-btn:hover {
      background-color: #1565c0;
    }

    .reset-btn {
      background-color: #757575;
    }

    .reset-btn:hover {
      background-color: #616161;
    }

    h1 {
      text-align: center;
      color: #2c3e50;
    }

    h2 {
      color: #1e88e5;
      margin-top: 30px;
      border-bottom: 1px solid #eee;
      padding-bottom: 5px;
    }

    .info-bar {
      text-align: center;
      margin-bottom: 20px;
      font-size: 0.9em;
      color: #7f8c8d;
    }

    /* å¯¼èˆªé¢æ¿ */
    .nav-panel {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      max-height: 80vh;
      overflow-y: auto;
      width: 250px;
      z-index: 1000;
    }

    .nav-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .bookmark-list {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 10px;
    }

    .bookmark-item {
      padding: 5px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
    }

    .bookmark-item:hover {
      background-color: #f0f0f0;
    }

    /* ç§»åŠ¨ç«¯é€‚é… */
    @media (max-width: 768px) {
      body {
        padding-right: 20px;
      }

      .nav-panel {
        position: static;
        width: auto;
        max-height: none;
        margin-bottom: 20px;
      }

      .user-info {
        right: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- ç™»å½•è¦†ç›–å±‚ -->
  <div id="loginOverlay" class="login-overlay">
    <div class="login-box">
      <h2 class="login-title">ä¹ æ€æƒ³å­¦ä¹ ç³»ç»Ÿ</h2>
      <div id="loginError" class="login-error"></div>

      <form id="loginForm" onsubmit="return false;">
        <input type="text" id="username" class="login-input" placeholder="ç”¨æˆ·å" required>
        <input type="password" id="password" class="login-input" placeholder="å¯†ç " required>
        <button type="submit" class="login-btn" onclick="attemptLogin()">ç™»å½•</button>
      </form>

      <div class="login-footer">
        è¯·è”ç³»ç®¡ç†å‘˜æ³¨å†Œè´¦å·
      </div>
    </div>
  </div>

  <!-- ç”¨æˆ·ä¿¡æ¯æ  -->
  <div id="userInfoBar" class="user-info" style="display:none;">
    æ¬¢è¿, <span id="displayUserName"></span>
    <span class="logout-btn" onclick="logout()">é€€å‡º</span>
  </div>

  <!-- ä¸»å†…å®¹åŒºåŸŸ -->
  <div id="mainContent" style="display:none;">
    <div class="nav-panel" id="navPanel">
      <div class="nav-buttons">
        <button onclick="scrollToTop()">é¡¶éƒ¨</button>
        <button onclick="scrollToBottom()">åº•éƒ¨</button>
        <button class="toggle-answers-btn" onclick="toggleAllAnswers()">æ˜¾ç¤ºæ‰€æœ‰ç­”æ¡ˆ</button>
        <button class="clear-bookmarks-btn" onclick="clearAllBookmarks()">æ¸…é™¤æ‰€æœ‰æ ‡è®°</button>
      </div>

      <h3>é¢˜ç›®å¯¼èˆª</h3>
      <input type="text" id="searchInput" placeholder="æœç´¢é¢˜ç›®..." oninput="searchQuestions()">

      <h3>æ ‡è®°é¢˜ç›®</h3>
      <div class="bookmark-list" id="bookmarkList">
        <div style="color:#999; text-align:center;">æš‚æ— æ ‡è®°é¢˜ç›®</div>
      </div>
    </div>

    <h1>ä¹ æ€æƒ³é€‰æ‹©åˆé›†</h1>
    <div class="info-bar">
      å…± <span id="totalQuestions">0</span> é“é¢˜ç›® | ç”Ÿæˆæ—¶é—´: <span id="generateTime"></span>
    </div>

    <h2 id="single-choice-section">ä¸€ã€å•é€‰é¢˜</h2>
    <div id="singleChoiceBlocks"></div>

    <h2 id="multi-choice-section">äºŒã€å¤šé€‰é¢˜</h2>
    <div id="multiChoiceBlocks"></div>

    <h2 id="judge-section">ä¸‰ã€åˆ¤æ–­é¢˜</h2>
    <div id="judgeBlocks"></div>
  </div>

<script>
// ================= ç”¨æˆ·ç™»å½•ç³»ç»Ÿ =================
const USER_DATABASE = {
  "admin": {
    password: "admin123",
    name: "ç®¡ç†å‘˜"
  },
  "lisi": {
    password: "123",
    name: "æå››"
  }
};

// å°è¯•ç™»å½•
function attemptLogin() {
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value;
  const errorElement = document.getElementById('loginError');

  if (!username || !password) {
    errorElement.textContent = "è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ";
    return;
  }

  const user = USER_DATABASE[username];
  if (!user) {
    errorElement.textContent = "ç”¨æˆ·åä¸å­˜åœ¨";
    return;
  }

  if (password !== user.password) {
    errorElement.textContent = "å¯†ç é”™è¯¯";
    return;
  }

  // ç™»å½•æˆåŠŸ
  startUserSession(username, user.name);
}

// å¯åŠ¨ç”¨æˆ·ä¼šè¯
function startUserSession(username, displayName) {
  localStorage.setItem('xxtSession', JSON.stringify({
    username: username,
    displayName: displayName,
    loginTime: new Date().toISOString()
  }));

  // æ›´æ–°UI
  document.getElementById('loginOverlay').style.display = 'none';
  document.getElementById('userInfoBar').style.display = 'block';
  document.getElementById('mainContent').style.display = 'block';
  document.getElementById('displayUserName').textContent = displayName;

  // åˆå§‹åŒ–åº”ç”¨
  initOriginalApp();
}

// é€€å‡ºç™»å½•
function logout() {
  localStorage.removeItem('xxtSession');
  location.reload();
}

// ================= é¢˜ç›®å¤„ç†ç³»ç»Ÿ =================
let bookmarks = {};
const correctAnswers = {};
const userSelections = {};
let answersVisible = false;

// åˆå§‹åŒ–é¢˜ç›®
function initOriginalApp() {
  // åŠ è½½ä¹¦ç­¾
  bookmarks = loadBookmarks() || {};

  // åˆå§‹åŒ–é¢˜ç›®æ•°æ®
  const sampleQuestions = {
    single: [
      `1. ä¹ è¿‘å¹³æ–°æ—¶ä»£ä¸­å›½ç‰¹è‰²ç¤¾ä¼šä¸»ä¹‰æ€æƒ³çš„æ ¸å¿ƒè¦ä¹‰æ˜¯ï¼š
A. å®ç°ç¤¾ä¼šä¸»ä¹‰ç°ä»£åŒ–
B. åšæŒå’Œå‘å±•ä¸­å›½ç‰¹è‰²ç¤¾ä¼šä¸»ä¹‰
C. å…¨é¢å»ºæˆå°åº·ç¤¾ä¼š
D. å…¨é¢æ·±åŒ–æ”¹é©
æ­£ç¡®ç­”æ¡ˆ: B`,
      `2. "ä¸¤ä¸ªç»´æŠ¤"æ˜¯æŒ‡ï¼š
A. ç»´æŠ¤ä¹ è¿‘å¹³æ€»ä¹¦è®°å…šä¸­å¤®çš„æ ¸å¿ƒã€å…¨å…šçš„æ ¸å¿ƒåœ°ä½ï¼Œç»´æŠ¤å…šä¸­å¤®æƒå¨å’Œé›†ä¸­ç»Ÿä¸€é¢†å¯¼
B. ç»´æŠ¤å›½å®¶ä¸»æƒå’Œé¢†åœŸå®Œæ•´ï¼Œç»´æŠ¤æ°‘æ—å°Šä¸¥
C. ç»´æŠ¤ç¤¾ä¼šå…¬å¹³æ­£ä¹‰ï¼Œç»´æŠ¤äººæ°‘åˆæ³•æƒç›Š
D. ç»´æŠ¤ä¸–ç•Œå’Œå¹³ï¼Œç»´æŠ¤å›½é™…å…¬å¹³æ­£ä¹‰
æ­£ç¡®ç­”æ¡ˆ: A`
    ],
    multi: [
      `1. ä¸‹åˆ—å“ªäº›æ˜¯"å››ä¸ªå…¨é¢"æˆ˜ç•¥å¸ƒå±€çš„å†…å®¹ï¼Ÿï¼ˆå¤šé€‰é¢˜ï¼‰
A. å…¨é¢å»ºè®¾ç¤¾ä¼šä¸»ä¹‰ç°ä»£åŒ–å›½å®¶
B. å…¨é¢æ·±åŒ–æ”¹é©
C. å…¨é¢ä¾æ³•æ²»å›½
D. å…¨é¢ä»ä¸¥æ²»å…š
æ­£ç¡®ç­”æ¡ˆ: A B C D`,
      `2. "äº”ä½ä¸€ä½“"æ€»ä½“å¸ƒå±€åŒ…æ‹¬ï¼šï¼ˆå¤šé€‰é¢˜ï¼‰
A. ç»æµå»ºè®¾
B. æ”¿æ²»å»ºè®¾
C. æ–‡åŒ–å»ºè®¾
D. ç¤¾ä¼šå»ºè®¾
E. ç”Ÿæ€æ–‡æ˜å»ºè®¾
æ­£ç¡®ç­”æ¡ˆ: A B C D E`
    ],
    judge: [
      `1. ä¸­å›½ç‰¹è‰²ç¤¾ä¼šä¸»ä¹‰æœ€æœ¬è´¨çš„ç‰¹å¾æ˜¯ä¸­å›½å…±äº§å…šçš„é¢†å¯¼ã€‚ï¼ˆåˆ¤æ–­é¢˜ï¼‰
A. æ­£ç¡®
B. é”™è¯¯
æ­£ç¡®ç­”æ¡ˆ: A`,
      `2. æ–°æ—¶ä»£æˆ‘å›½ç¤¾ä¼šä¸»è¦çŸ›ç›¾å·²ç»è½¬åŒ–ä¸ºäººæ°‘æ—¥ç›Šå¢é•¿çš„ç¾å¥½ç”Ÿæ´»éœ€è¦å’Œä¸å¹³è¡¡ä¸å……åˆ†çš„å‘å±•ä¹‹é—´çš„çŸ›ç›¾ã€‚ï¼ˆåˆ¤æ–­é¢˜ï¼‰
A. æ­£ç¡®
B. é”™è¯¯
æ­£ç¡®ç­”æ¡ˆ: A`
    ]
  };

  // å¤„ç†å•é€‰é¢˜
  let single_html = "";
  sampleQuestions.single.forEach((q, i) => {
    const result = formatQuestionBlock(q, i+1, "single");
    single_html += result.html;
    correctAnswers[result.anchor_id] = result.answer_line.split(":")[1].trim().split(/\s+/);
    userSelections[result.anchor_id] = [];
  });

  // å¤„ç†å¤šé€‰é¢˜
  let multi_html = "";
  sampleQuestions.multi.forEach((q, i) => {
    const result = formatQuestionBlock(q, i+1, "multi");
    multi_html += result.html;
    correctAnswers[result.anchor_id] = result.answer_line.split(":")[1].trim().split(/\s+/);
    userSelections[result.anchor_id] = [];
  });

  // å¤„ç†åˆ¤æ–­é¢˜
  let judge_html = "";
  sampleQuestions.judge.forEach((q, i) => {
    const result = formatQuestionBlock(q, i+1, "judge");
    judge_html += result.html;
    correctAnswers[result.anchor_id] = [result.answer_line.includes("A") ? "A" : "B"];
    userSelections[result.anchor_id] = [];
  });

  // æ›´æ–°DOM
  document.getElementById('singleChoiceBlocks').innerHTML = single_html;
  document.getElementById('multiChoiceBlocks').innerHTML = multi_html;
  document.getElementById('judgeBlocks').innerHTML = judge_html;
  document.getElementById('totalQuestions').textContent =
    sampleQuestions.single.length + sampleQuestions.multi.length + sampleQuestions.judge.length;
  document.getElementById('generateTime').textContent = new Date().toLocaleDateString();

  // åˆå§‹åŒ–æ ‡è®°çŠ¶æ€
  Object.keys(bookmarks).forEach(id => {
    if (bookmarks[id]) {
      const marker = document.querySelector(`#${id} .question-marker`);
      if (marker) marker.classList.add('marked');
    }
  });

  updateBookmarkList();

  // åˆå§‹åŒ–é€‰é¡¹ç‚¹å‡»äº‹ä»¶
  initQuestionInteractions();
}

// æ ¼å¼åŒ–é¢˜ç›®å—
function formatQuestionBlock(block, new_number, question_type) {
  if (!block.trim()) return { html: "", answer_line: "", anchor_id: "" };

  const lines = block.split('\n').map(line => line.trim()).filter(line => line);
  let original_number = "";

  if (lines.length && /^\d+\./.test(lines[0])) {
    original_number = lines[0].match(/^(\d+)\./)[1];
  }

  let detected_type = "";
  const question_desc = [];
  let i = 0;

  while (i < lines.length && !/^[A-D]\.?$/.test(lines[i]) && !lines[i].startsWith("æ­£ç¡®ç­”æ¡ˆ")) {
    if (lines[i] && !lines[i].startsWith("ç­”æ¡ˆè§£é‡Š")) {
      if (lines[i].includes("å•é€‰é¢˜")) detected_type = "single";
      else if (lines[i].includes("å¤šé€‰é¢˜")) detected_type = "multi";
      else if (lines[i].includes("åˆ¤æ–­é¢˜")) detected_type = "judge";
      question_desc.push(lines[i]);
    }
    i++;
  }

  const q_type = question_type || detected_type;
  const options = [];
  const option_correct = [];
  let correct_letters = [];
  let answer_line = lines.find(line => line.startsWith("æ­£ç¡®ç­”æ¡ˆ")) || "";

  if (answer_line) {
    correct_letters = answer_line.split(":")[1].trim().split(/\s+/);
  }

  // åˆ¤æ–­é¢˜ç‰¹æ®Šå¤„ç†
  if (q_type === "judge") {
    options.push("A. æ­£ç¡®", "B. é”™è¯¯");
    if (correct_letters.length) {
      option_correct.push(correct_letters[0] === "A", correct_letters[0] === "B");
    }
  } else {
    // å¤„ç†é€‰æ‹©é¢˜é€‰é¡¹
    while (i < lines.length && /^[A-D]\.?$/.test(lines[i])) {
      const letter = lines[i].replace('.', '');
      i++;
      if (i < lines.length && lines[i] === '.') i++;

      const content_lines = [];
      while (i < lines.length && !/^[A-D]\.?$/.test(lines[i]) && !lines[i].startsWith("æ­£ç¡®ç­”æ¡ˆ")) {
        if (lines[i] && lines[i] !== '.') {
          content_lines.push(lines[i].trim());
        }
        i++;
      }

      const option_content = content_lines.join('').trim();
      if (option_content) {
        options.push(`${letter}. ${option_content}`);
        option_correct.push(correct_letters.includes(letter));
      }
    }
  }

  // é‡æ–°ç¼–å·ç¬¬ä¸€è¡Œ
  if (new_number !== undefined && question_desc.length) {
    question_desc[0] = question_desc[0].replace(/^\d+\./, `${new_number}.`);
  }

  // ç”Ÿæˆå”¯ä¸€é”šç‚¹ID
  const anchor_id = `q${new_number || original_number}`;
  const question_class = `question-block ${q_type ? q_type + '-choice' : ''}`;

  // æ„å»ºHTML
  let html_result = [
    `<div class="${question_class}" id="${anchor_id}">`,
    '  <div class="question-header">',
    `    <div class="question-marker" onclick="toggleBookmark('${anchor_id}')">ğŸ“Œ</div>`,
    ...question_desc.map(desc => `    <div class="question-desc">${desc}</div>`),
    '  </div>'
  ];

  if (options.length) {
    html_result.push('  <div class="options">');
    options.forEach((option, idx) => {
      html_result.push(
        `    <div class="option" data-correct="${option_correct[idx]}" data-letter="${option[0]}">${option}</div>`
      );
    });
    html_result.push('  </div>');
    html_result.push('  <div style="display: flex; justify-content: space-between; margin-top: 10px;">');
    html_result.push(`    <button class="check-btn" onclick="checkSingleAnswer('${anchor_id}')">ç¡®è®¤ç­”æ¡ˆ</button>`);
    html_result.push(`    <button class="reset-btn" onclick="resetQuestion('${anchor_id}')">é‡ç½®</button>`);
    html_result.push('  </div>');
  }

  html_result.push('  <div class="answer-feedback" style="display:none;"></div>');
  if (answer_line) {
    html_result.push(`  <div class="correct-answer" style="display:none;">${answer_line}</div>`);
  }
  html_result.push('</div>');

  return {
    html: html_result.join('\n'),
    answer_line,
    anchor_id
  };
}

// åˆå§‹åŒ–é¢˜ç›®äº¤äº’
function initQuestionInteractions() {
  document.querySelectorAll('.question-block').forEach(block => {
    const id = block.id;
    const options = block.querySelectorAll('.option');

    options.forEach(option => {
      option.addEventListener('click', function() {
        const questionId = this.closest('.question-block').id;
        const optionLetter = this.dataset.letter;
        const currentOptions = this.closest('.question-block').querySelectorAll('.option');

        // å¦‚æœæ˜¯å•é€‰é¢˜æˆ–åˆ¤æ–­é¢˜ï¼Œå…ˆæ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
        if (block.classList.contains('single-choice') || block.classList.contains('judge-question')) {
          currentOptions.forEach(opt => opt.classList.remove('selected'));
          userSelections[questionId] = [];
        }

        // åˆ‡æ¢é€‰ä¸­çŠ¶æ€
        if (this.classList.contains('selected')) {
          this.classList.remove('selected');
          const index = userSelections[questionId].indexOf(optionLetter);
          if (index !== -1) {
            userSelections[questionId].splice(index, 1);
          }
        } else {
          this.classList.add('selected');
          userSelections[questionId].push(optionLetter);
        }
      });
    });
  });
}

// ================= åº”ç”¨åŠŸèƒ½å‡½æ•° =================
// æ£€æŸ¥å•ä¸ªé¢˜ç›®ç­”æ¡ˆ
function checkSingleAnswer(questionId) {
  const block = document.getElementById(questionId);
  const userAnswer = [...userSelections[questionId]];
  const correctAnswer = [...correctAnswers[questionId]];
  const feedback = block.querySelector('.answer-feedback');
  const correctAnswerDiv = block.querySelector('.correct-answer');
  const options = block.querySelectorAll('.option');

  // é‡ç½®æ‰€æœ‰é€‰é¡¹æ ·å¼
  options.forEach(opt => {
    opt.classList.remove('selected', 'correct', 'wrong');
  });

  // æ ‡è®°æ­£ç¡®ç­”æ¡ˆå’Œé”™è¯¯ç­”æ¡ˆ
  options.forEach(option => {
    if (option.dataset.correct === 'true') {
      option.classList.add('correct');
    }
    if (userSelections[questionId].includes(option.dataset.letter) &&
        option.dataset.correct !== 'true') {
      option.classList.add('wrong');
    }
  });

  // æ£€æµ‹é¢˜å‹
  const isMultiChoice = block.classList.contains('multi-choice');
  const isJudgeQuestion = block.classList.contains('judge-question');

  let isCorrect = false;

  if (isMultiChoice) {
    // å¤šé€‰é¢˜ï¼šå¿…é¡»æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š
    // 1. ç”¨æˆ·é€‰æ‹©çš„é€‰é¡¹æ•°é‡ç­‰äºæ­£ç¡®ç­”æ¡ˆæ•°é‡
    // 2. ç”¨æˆ·é€‰æ‹©çš„æ‰€æœ‰é€‰é¡¹éƒ½æ˜¯æ­£ç¡®ç­”æ¡ˆ
    isCorrect = userAnswer.length === correctAnswer.length &&
                userAnswer.every(letter => correctAnswer.includes(letter));
  } else if (isJudgeQuestion) {
    // åˆ¤æ–­é¢˜ï¼šç›´æ¥æ¯”è¾ƒç¬¬ä¸€ä¸ªé€‰é¡¹
    isCorrect = userAnswer.length === 1 && userAnswer[0] === correctAnswer[0];
  } else {
    // å•é€‰é¢˜ï¼šç›´æ¥æ¯”è¾ƒç¬¬ä¸€ä¸ªé€‰é¡¹
    isCorrect = userAnswer.length === 1 && userAnswer[0] === correctAnswer[0];
  }

  if (isCorrect) {
    feedback.textContent = 'âœ“ å›ç­”æ­£ç¡®';
    feedback.style.color = 'green';
  } else {
    feedback.textContent = 'âœ— å›ç­”é”™è¯¯';
    feedback.style.color = 'red';
  }

  // æ¸…ç©ºç”¨æˆ·é€‰æ‹©
  userSelections[questionId] = [];
  feedback.style.display = 'block';
  correctAnswerDiv.style.display = 'block';
}

// é‡ç½®é¢˜ç›®çŠ¶æ€
function resetQuestion(questionId) {
  const block = document.getElementById(questionId);
  const options = block.querySelectorAll('.option');
  const feedback = block.querySelector('.answer-feedback');
  const correctAnswerDiv = block.querySelector('.correct-answer');

  options.forEach(opt => {
    opt.classList.remove('selected', 'correct', 'wrong', 'correct-highlight');
  });

  userSelections[questionId] = [];
  feedback.style.display = 'none';
  correctAnswerDiv.style.display = 'none';
}

// æ ‡è®°/å–æ¶ˆæ ‡è®°é¢˜ç›®
function toggleBookmark(id) {
  const marker = document.querySelector(`#${id} .question-marker`);
  bookmarks[id] = !bookmarks[id];

  if (bookmarks[id]) {
    marker.classList.add('marked');
  } else {
    marker.classList.remove('marked');
  }

  updateBookmarkList();
  saveBookmarks();
}

// æ›´æ–°æ ‡è®°åˆ—è¡¨
function updateBookmarkList() {
  const list = document.getElementById('bookmarkList');
  list.innerHTML = '';

  let hasBookmarks = false;

  Object.keys(bookmarks).forEach(id => {
    if (bookmarks[id]) {
      hasBookmarks = true;
      const question = document.getElementById(id);
      if (question) {
        const title = question.querySelector('.question-desc').textContent.trim();
        const item = document.createElement('div');
        item.className = 'bookmark-item';
        item.innerHTML = `${title.substring(0, 30)}${title.length > 30 ? '...' : ''} <button onclick="scrollToQuestion('${id}')">è·³è½¬</button>`;
        list.appendChild(item);
      }
    }
  });

  if (!hasBookmarks) {
    list.innerHTML = '<div style="color:#999; text-align:center;">æš‚æ— æ ‡è®°é¢˜ç›®</div>';
  }
}

// ä¿å­˜ä¹¦ç­¾
function saveBookmarks() {
  localStorage.setItem('questionBookmarks', JSON.stringify(bookmarks));
}

// åŠ è½½ä¹¦ç­¾
function loadBookmarks() {
  const saved = localStorage.getItem('questionBookmarks');
  return saved ? JSON.parse(saved) : null;
}

// è·³è½¬åˆ°æŒ‡å®šé¢˜ç›®
function scrollToQuestion(id) {
  const element = document.getElementById(id);
  if (element) {
    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}

// æ»šåŠ¨åˆ°é¡¶éƒ¨
function scrollToTop() {
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// æ»šåŠ¨åˆ°åº•éƒ¨
function scrollToBottom() {
  window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
}

// æœç´¢é¢˜ç›®
function searchQuestions() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const blocks = document.querySelectorAll('.question-block');

  blocks.forEach(block => {
    const text = block.textContent.toLowerCase();
    if (searchTerm === '' || text.includes(searchTerm)) {
      block.style.display = 'block';
    } else {
      block.style.display = 'none';
    }
  });
}

// åˆ‡æ¢æ‰€æœ‰ç­”æ¡ˆæ˜¾ç¤ºçŠ¶æ€
function toggleAllAnswers() {
  answersVisible = !answersVisible;
  const btn = document.querySelector('.toggle-answers-btn');

  document.querySelectorAll('.question-block').forEach(block => {
    const correctAnswerDiv = block.querySelector('.correct-answer');
    const options = block.querySelectorAll('.option');

    if (answersVisible) {
      if (correctAnswerDiv) correctAnswerDiv.style.display = 'block';
      options.forEach(option => {
        if (option.dataset.correct === 'true') {
          option.classList.add('correct-highlight');
        }
      });
      btn.textContent = 'éšè—æ‰€æœ‰ç­”æ¡ˆ';
    } else {
      if (correctAnswerDiv) correctAnswerDiv.style.display = 'none';
      options.forEach(option => {
        option.classList.remove('correct-highlight');
      });
      btn.textContent = 'æ˜¾ç¤ºæ‰€æœ‰ç­”æ¡ˆ';
    }
  });
}

// æ¸…é™¤æ‰€æœ‰æ ‡è®°
function clearAllBookmarks() {
  if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ ‡è®°é¢˜ç›®å—ï¼Ÿ')) {
    Object.keys(bookmarks).forEach(id => {
      bookmarks[id] = false;
      const marker = document.querySelector(`#${id} .question-marker`);
      if (marker) marker.classList.remove('marked');
    });

    updateBookmarkList();
    saveBookmarks();
  }
}

// ============= é¡µé¢åˆå§‹åŒ– =============
window.onload = function() {
  // è®¾ç½®ç”Ÿæˆæ—¶é—´
  document.getElementById('generateTime').textContent = new Date().toLocaleDateString();

  // æ£€æŸ¥ä¼šè¯
  const sessionData = localStorage.getItem('xxtSession');

  if (sessionData) {
    try {
      const data = JSON.parse(sessionData);
      startUserSession(data.username, data.displayName);
    } catch (e) {
      console.error("ä¼šè¯æ•°æ®è§£æé”™è¯¯", e);
    }
  }
};
</script>
</body>
</html>